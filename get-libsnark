#!/bin/bash
# To pass options options to libsnark Makefile, put them in env var LIBSNARK_FLAGS.
# To clone libsnark from an alternate location, set env var LIBSNARK_SRC. For example:
#  LIBSNARK_SRC="$HOME/libsnark.git --branch master" ./get-libsnark
# To use curve BN128 instead of BN128 (which is x64-only), use:
#  CURVE=BN128 ./get-libsnark
# and pass CURVE=BN128 as an argument to make.

set -e

LIBFF_BRANCH=${LIBFF_BRANCH:-master}
LIBFQFFT_BRANCH=${LIBFQFFT_BRANCH:-master}
LIBSNARK_BRANCH=${LIBSNARK_BRANCH:-candidate-master}

LIBFF_SRC=${LIBFF_SRC:-https://github.com/scipr-lab/libff}
LIBFQFFT_SRC=${LIBFQFFT_SRC:-https://github.com/scipr-lab/libfqfft}
LIBSNARK_SRC=${LIBSNARK_SRC:-https://github.com/scipr-lab/libsnark}

CURVE=${CURVE:-ALT_BN128}

LIBSNARK_FLAGS="$LIBSNARK_FLAGS -DWITH_SUPERCOP=OFF -DCURVE=$CURVE"
if [[ `uname -s` == "Darwin" ]]; then
    LIBSNARK_FLAGS="$LIBSNARK_FLAGS -DWITH_PROCPS=OFF"
fi

set -x

DEPSRC=./depsrc
DEPINST=./depinst

mkdir -p $DEPINST
DEPINST=`pwd -P`/$DEPINST  # remember absolute path

mkdir -p $DEPSRC
cd $DEPSRC

[ ! -d gtest-build ] && mkdir gtest-build
cd gtest-build
cmake /usr/src/gtest/ -DCMAKE_INSTALL_PREFIX=$ROOT
make -j
mkdir  -p $DEPINST/lib
cp libgtest* $DEPINST/lib
cd ..

[ -d libff ] || git clone --recursive -b $LIBFF_BRANCH $LIBFF_SRC
cd libff
rm -rf build
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=$DEPINST
make -j
make install
cd ../../

[ -d libfqfft ] || git clone --recursive -b $LIBFQFFT_BRANCH $LIBFQFFT_SRC
cd libfqfft
rm -rf build
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=$DEPINST -DCMAKE_PREFIX_PATH=$DEPINST
make -j
make install
cd ../../

[ -d libsnark ] || git clone --recursive -b $LIBSNARK_BRANCH $LIBSNARK_SRC
cd libsnark
rm -rf build
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=$DEPINST -DCMAKE_PREFIX_PATH=$DEPINST $LIBSNARK_FLAGS
make -j
make install
cd ../../
